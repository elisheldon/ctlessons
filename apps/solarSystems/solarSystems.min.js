var game=new Phaser.Game(1280,600,Phaser.AUTO,"phaserDiv",{preload:gamePreload,create:gameCreate,update:gameUpdate}),G=6.673e-11,originalMetersToPixels=1.8e-9,metersToPixels=originalMetersToPixels,pixelsToMeters=1/originalMetersToPixels,timeScale=1e6,oldTime=0,creating=0,starCenterX=500,starCenterY=300,massSliderValue=.5,velocitySliderValue=.5,createMass=1e25,createVelocityX=0,createVelocityY=0,timePassed=0,starMass=1.972e30,planetCount=1,asteroidCount=0,meteorCount=0,planetSelected=null,scaleChanging=!1,scaleSliderValue=.7;function gamePreload(){game.load.image("circle","circle.png"),game.load.image("ring","ring.png"),game.load.image("black","black.gif"),game.load.image("star","star.png"),slickUI=game.plugins.add(Phaser.Plugin.SlickUI),slickUI.load("kenney/kenney.json")}function gameCreate(){game.stage.backgroundColor="#000000",background=game.add.sprite(0,0,"black"),background.width=990,background.height=600,background.inputEnabled=!0,background.events.onInputDown.add(backgroundClick,this),planets=game.add.group(),star=planets.create(starCenterX,300,"star"),star.anchor.set(.5),star.scale.setTo(.5),star.mass=starMass,star.velocityX=0,star.velocityY=0,star.overlaps=zeroArray(),star.inputEnabled=!0;var e=planets.create(starCenterX-1496e8*metersToPixels,300,"circle");e.tint=1573119,e.anchor.set(.5),e.scale.setTo(.5),e.mass=5.972e24,e.velocityX=0,e.velocityY=29783,e.type="Planet",e.number=1,e.overlaps=zeroArray(),e.inputEnabled=!0,e.events.onInputDown.add(selectPlanet,this),slickUI.add(panel=new SlickUI.Element.Panel(game.width-288,8,280,game.height-16)),panel.add(new SlickUI.Element.Text(10,10,"Simulation speed:")),panel.add(timeScaleSlider=new SlickUI.Element.Slider(16,65,panel.width-32,.4)),timeScaleSlider.onDrag.add(function(e){updateTimeScale(e)}),panel.add(new SlickUI.Element.Text(10,125,"Zoom level:")),panel.add(scaleSlider=new SlickUI.Element.Slider(16,180,panel.width-32,.7)),scaleSlider.onDrag.add(function(e){scaleChanging=!0,scaleSliderValue=e}),panel.add(starMassText=new SlickUI.Element.Text(10,240,"Mass of star: 1.97e+30 kg")),panel.add(starMassSlider=new SlickUI.Element.Slider(16,295,panel.width-32,.5)),starMassSlider.onDrag.add(function(e){updateStarMass(e)}),panel.add(selectedPlanetText=new SlickUI.Element.Text(10,350,"Selected body: none")),panel.add(selectedPlanetMassText=new SlickUI.Element.Text(10,380,"")),panel.add(selectedPlanetDistanceText=new SlickUI.Element.Text(10,410,"")),panel.add(selectedPlanetSpeedText=new SlickUI.Element.Text(10,440,"")),panel.add(deleteButton=new SlickUI.Element.Button(50,475,panel.width-100,34)),deleteButton.add(new SlickUI.Element.Text(0,0,"Delete this body")).center(),deleteButton.alpha=0,deleteButton.events.onInputUp.add(function(){selectedPlanetText.value="Selected body: none",selectedPlanetDistanceText.value="",selectedPlanetMassText.value="",selectedPlanetSpeedText.value="",planetSelected.destroy(),planetSelected=null,deleteButton.alpha=0}),panel.add(timePassedText=new SlickUI.Element.Text(10,538,"Days\t: 0")),panel.add(restartButton=new SlickUI.Element.Button(185,535,80,34)),restartButton.add(new SlickUI.Element.Text(0,0,"Restart")).center(),restartButton.events.onInputUp.add(function(){location.reload()}),createCreatePanel()}function gameUpdate(){scaleChanging&&(scaleChanging=!1,rescaleSpace(scaleSliderValue)),timestep=game.time.elapsed/1e3*timeScale,timePassed+=timestep;for(var e=0;e<planets.length;e++){var t=planets.children[e];t.forceX=0,t.forceY=0;for(var a=0;a<planets.length;a++)if(a!=e){var l=planets.children[a],n=calcGravity(t,l);t.forceX+=n[0],t.forceY+=n[1],checkOverlap(t,l)&&1!=t.overlaps[a]&&0!=e&&0!=a?(t.overlaps[a]=!0,l.overlaps[e]=!0,planetsCollide(t,l,1)):checkOverlap(t,l)&&0!=e&&0!=a?(t.overlaps[a]=!0,l.overlaps[e]=!0,planetsCollide(t,l,1)):checkOverlap(t,l)||(t.overlaps[a]=!1,l.overlaps[e]=!1)}t.velocityX+=t.forceX/t.mass*timestep,t.velocityY+=t.forceY/t.mass*timestep,t.position.x+=t.velocityX*metersToPixels*timestep,t.position.y+=t.velocityY*metersToPixels*timestep,e>0&&Math.sqrt((star.position.x-t.position.x)**2+(star.position.y-t.position.y)**2)<star.width/2&&(t==planetSelected&&(selectedPlanetText.value="Selected body: none",selectedPlanetDistanceText.value="",selectedPlanetMassText.value="",selectedPlanetSpeedText.value="",planetSelected=null,deleteButton.alpha=0),t.destroy()),null!=planetSelected&&(selectedPlanetDistanceText.value="Distance from star: "+(Math.sqrt((planetSelected.position.x-star.position.x)**2+(planetSelected.position.y-star.position.y)**2)*pixelsToMeters).toExponential(2)+" m",selectedPlanetSpeedText.value="Speed: "+Math.sqrt(planetSelected.velocityX**2+planetSelected.velocityY**2).toExponential(2)+" m/s")}timePassedText.value=timePassed>31536e3?"Years: "+(timePassed/31536e3).toFixed(2):"Days: "+(timePassed/86400).toFixed(0)}function rescaleSpace(e){for(var t=1.8e-9*10**(e-.7),a=metersToPixels,l=0;l<planets.length;l++){var n=planets.children[l];n.position.x=starCenterX-(starCenterX-n.position.x)*t/a,n.position.y=starCenterY-(starCenterY-n.position.y)*t/a,n.scale.setTo(n.scale.x*t/a)}pixelsToMeters=1/(metersToPixels=t)}function calcGravity(e,t){var a=(e.position.x-t.position.x)*pixelsToMeters,l=(e.position.y-t.position.y)*pixelsToMeters,n=a**2+l**2,s=G*e.mass*t.mass/n,i=Math.atan2(l,a);return[-Math.cos(i)*s,-Math.sin(i)*s]}function createCreatePanel(){slickUI.add(createDialog=new SlickUI.Element.Panel(300,100,400,400)),createDialog.add(new SlickUI.Element.Text(10,10,"Create a new...")),createDialog.add(cbMeteor=new SlickUI.Element.Checkbox(10,50,SlickUI.Element.Checkbox.TYPE_RADIO)),createDialog.add(new SlickUI.Element.Text(50,53,"Meteor")),cbMeteor.events.onInputDown.add(function(){cbPlanet.checked=!1,cbAsteroid.checked=!1,cbMeteor.checked=!0,updateCreateMass(massSliderValue)}),createDialog.add(cbAsteroid=new SlickUI.Element.Checkbox(136,50,SlickUI.Element.Checkbox.TYPE_RADIO)),createDialog.add(new SlickUI.Element.Text(176,53,"Asteroid")),cbAsteroid.events.onInputDown.add(function(){cbPlanet.checked=!1,cbMeteor.checked=!1,cbAsteroid.checked=!0,updateCreateMass(massSliderValue)}),createDialog.add(cbPlanet=new SlickUI.Element.Checkbox(278,50,SlickUI.Element.Checkbox.TYPE_RADIO)),cbPlanet.checked=!0,createDialog.add(new SlickUI.Element.Text(318,53,"Planet")),cbPlanet.events.onInputDown.add(function(){cbMeteor.checked=!1,cbAsteroid.checked=!1,cbPlanet.checked=!0,updateCreateMass(massSliderValue)}),createDialog.add(massSlider=new SlickUI.Element.Slider(16,160,createDialog.width-32,.5)),massSlider.onDrag.add(function(e){updateCreateMass(e),massSliderValue=e}),createDialog.add(massText=new SlickUI.Element.Text(16,110,"Mass: 5.97e+24 kg")),createDialog.add(velocitySlider=new SlickUI.Element.Slider(16,250,createDialog.width-32,.5)),createDialog.add(velocityText=new SlickUI.Element.Text(16,200,"Initial speed: ")),velocitySlider.onDrag.add(function(e){updateCreateVelocity(e,xClicked,yClicked),velocitySliderValue=e}),createDialog.add(new SlickUI.Element.Text(16,290,"Orbit direction: ")),createDialog.add(cbCW=new SlickUI.Element.Checkbox(180,287,SlickUI.Element.Checkbox.TYPE_RADIO)),createDialog.add(new SlickUI.Element.Text(220,290,"CW")),cbCW.events.onInputDown.add(function(){cbCCW.checked=!1,cbCW.checked=!0}),createDialog.add(cbCCW=new SlickUI.Element.Checkbox(290,287,SlickUI.Element.Checkbox.TYPE_RADIO)),createDialog.add(new SlickUI.Element.Text(330,290,"CCW")),cbCCW.events.onInputDown.add(function(){cbCW.checked=!1,cbCCW.checked=!0}),cbCCW.checked=!0,createDialog.add(createButton=new SlickUI.Element.Button(8,342,184,42)),createButton.add(new SlickUI.Element.Text(0,0,"Create")).center(),createButton.events.onInputUp.add(function(){createNewPlanet(xClicked,yClicked),createDialog.visible=!1}),createDialog.add(cancelButton=new SlickUI.Element.Button(200,342,184,42)),cancelButton.add(new SlickUI.Element.Text(0,0,"Cancel")).center(),cancelButton.events.onInputUp.add(function(){createDialog.visible=!1}),createDialog.alpha=.9,createDialog.visible=!1}function updateCreateMass(e){cbMeteor.checked?(createMass=1+Math.round(8*e),massText.value="Number: "+createMass+" meteors",1==createMass&&(massText.value="Number: "+createMass+" meteor")):cbAsteroid.checked?(createMass=1+Math.round(8*e),massText.value="Number: "+createMass+" asteroids",1==createMass&&(massText.value="Number: "+createMass+" asteroid")):cbPlanet.checked&&(createMass=5.972e24*10**(6*(e-.5)),massText.value="Mass: "+createMass.toExponential(2)+" kg")}function updateCreateVelocity(e,t,a){var l=calcStableVelocity(t,a),n=l[0],s=l[1];velocity=n*10**(2*(e-.5)),velocityText.value="Initial speed: "+velocity.toFixed(0)+" m/s",createVelocityX=-Math.sin(s)*velocity,createVelocityY=Math.cos(s)*velocity}function updateTimeScale(e){timeScale=0==e?0:2e6*10**(3*(e-.5))}function updateStarMass(e){star.scale.setTo(.5*metersToPixels/originalMetersToPixels*(.5+e)),star.mass=1.972e30*10**(4*(e-.5)),starMassText.value="Mass of star: "+star.mass.toExponential(2)+" kg"}function calcStableVelocity(e,t){var a=(star.position.x-e)*pixelsToMeters,l=(star.position.y-t)*pixelsToMeters,n=Math.atan2(l,a);return[Math.sqrt(G*star.mass/Math.sqrt(a**2+l**2)),n]}function createNewPlanet(e,t){if(cbPlanet.checked){(c=planets.create(e,t,"circle")).tint=16777215*Math.random(),c.scale.setTo(metersToPixels/originalMetersToPixels*(.4+.1*massSliderValue)),c.type="Planet",planetCount++,c.number=planetCount,c.anchor.set(.5),c.mass=createMass,cbCCW.checked?(c.velocityX=createVelocityX,c.velocityY=createVelocityY):(c.velocityX=-createVelocityX,c.velocityY=-createVelocityY),c.overlaps=zeroArray(),c.inputEnabled=!0,c.events.onInputDown.add(selectPlanet,this),selectPlanet(c)}else{var a=Math.atan2(t-star.position.y,e-star.position.x),l=Math.sqrt((e-star.position.x)**2+(t-star.position.y)**2);for(cbAsteroid.checked?angleScale=l/(60*(scaleSliderValue+.1)):angleScale=l/(30*(scaleSliderValue+.1)),i=0;i<createMass;i++){for(var n=star.position.x+(l-8+16*Math.random())*Math.cos(a+(i-Math.floor(createMass/2))/angleScale),s=star.position.y+(l-8+16*Math.random())*Math.sin(a+(i-Math.floor(createMass/2))/angleScale),c=planets.create(n,s,"circle"),o=0;o<8e6;){var r=255*Math.random(0,.01)|0;o=r<<16|r<<8|r}if(c.tint=o,cbAsteroid.checked){var d=Math.random(),p=1e17*10**(8*(d-.5));c.mass=p,c.scale.setTo(metersToPixels/originalMetersToPixels*(.15+.1*d)),c.type="Asteroid",asteroidCount++,c.number=asteroidCount}else{var u=Math.random(),m=1e9*10**(4*(u-.5));c.mass=m,c.scale.setTo(metersToPixels/originalMetersToPixels*(.05+.1*u)),c.type="Meteor",meteorCount++,c.number=meteorCount}c.anchor.set(.5),updateCreateVelocity(velocitySliderValue,n,s),cbCCW.checked?(c.velocityX=createVelocityX,c.velocityY=createVelocityY):(c.velocityX=-createVelocityX,c.velocityY=-createVelocityY),c.overlaps=zeroArray(),c.inputEnabled=!0,c.events.onInputDown.add(selectPlanet,this),0==i&&selectPlanet(c)}}}function selectPlanet(e,t){null!=planetSelected&&void 0!==planetSelected.children[0]&&planetSelected.children[0].destroy(),planetSelected=e,planetRing=game.add.sprite(0,0,"ring"),planetRing.anchor.set(.5),e.addChild(planetRing),selectedPlanetText.value="Selected body: "+e.type+" "+e.number,selectedPlanetMassText.value="Mass: "+e.mass.toExponential(2)+" kg",selectedPlanetDistanceText.value="Distance from star: "+(Math.sqrt((e.position.x-star.position.x)**2+(e.position.y-star.position.y)**2)*pixelsToMeters).toExponential(2)+" m",selectedPlanetSpeedText.value="Speed: "+Math.sqrt(e.velocityX**2+e.velocityY**2).toExponential(2)+" m/s",deleteButton.alpha=1}function backgroundClick(){createDialog.visible||(xClicked=game.input.activePointer.x,yClicked=game.input.activePointer.y,updateCreateVelocity(velocitySliderValue,xClicked,yClicked),createDialog.visible=!0)}function checkOverlap(e,t){return Math.sqrt((t.position.x-e.position.x)**2+(t.position.y-e.position.y)**2)<e.width/2+t.width/2}function planetsCollide(e,t,a){var l=e.velocityX,n=e.velocityY,s=Math.atan2(n,l),i=Math.sqrt(l**2+n**2),c=e.mass,o=t.velocityX,r=t.velocityY,d=Math.atan2(r,o),p=Math.sqrt(o**2+r**2),u=t.mass,m=Math.atan2(t.position.y-e.position.y,t.position.x-e.position.x),h=(i*Math.cos(s-m)*(c-u)+2*u*p*Math.cos(d-m))/(c+u)*Math.cos(m)+i*Math.sin(s-m)*Math.cos(m+Math.PI/2),x=(i*Math.cos(s-m)*(c-u)+2*u*p*Math.cos(d-m))/(c+u)*Math.sin(m)+i*Math.sin(s-m)*Math.sin(m+Math.PI/2),v=(p*Math.cos(d-m)*(u-c)+1*c*i*Math.cos(s-m))/(u+c)*Math.cos(m)+p*Math.sin(d-m)*Math.cos(m+Math.PI/2),M=(p*Math.cos(d-m)*(u-c)+1*c*i*Math.cos(s-m))/(u+c)*Math.sin(m)+p*Math.sin(d-m)*Math.sin(m+Math.PI/2),S=1,k=1;e.mass<t.mass?S=a:k=a,e.velocityX=h*S,e.velocityY=x*S,t.velocityX=v*k,t.velocityY=M*k}function zeroArray(){array=[],length=2+planetCount+asteroidCount+meteorCount;for(var e=0;e<length;e++)array.push(!1);return array}