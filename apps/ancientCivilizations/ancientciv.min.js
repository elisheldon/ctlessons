var c=document.getElementById("yearNavCanvas"),ctx=c.getContext("2d"),currentStage=null;foodBonusDict={beans:1,chickens:1,corn:1.5,cows:2,fish:1,oranges:.5,potatoes:1.5,wheat:2},warBonusResourceDict={bronze:.04,camels:.02,horses:.04,iron:.06,"pine trees":.02,stone:.02},warBonusLocationDict={desert:.1,island:.15,mountains:.15,ocean:.1,rainforest:.05,river:.05},$(document).ready(function(){$.ajax({type:"GET",url:"events.csv",dataType:"text",success:function(e){eventsObjArray=$.csv.toObjects(e)}}),$.ajax({type:"GET",url:"facts.csv",dataType:"text",success:function(e){factsArray=$.csv.toArray(e)}})});var config={apiKey:"AIzaSyAi58QpzMrObrr4SRu9_uZYXL8X5xQD3jQ",authDomain:"ancientciv-149617.firebaseapp.com",databaseURL:"https://ancientciv-149617.firebaseio.com",storageBucket:"ancientciv-149617.appspot.com",messagingSenderId:"136304861236"};firebase.initializeApp(config);var db=firebase.database(),provider=new firebase.auth.GoogleAuthProvider;function generateClassCode(){classCodeCreateNameIn.value="",classCodeGen=(Math.random().toString(36)+"00000000000000000").slice(2,8).toUpperCase(),db.ref("classrooms/"+classCodeGen).once("value").then(function(e){null!=e.val()?(console.log("Classroom code generated is not unique."),generateClassCode()):db.ref("classrooms/"+classCodeGen).set({creatoruid:user.uid})})}function recalcAnimalRP(e){switch(e){case"camels":camelsRP=document.getElementById("camelsIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(camelsRP=20-catsRP-chickensRP-cowsRP-dogsRP-fishRP-horsesRP-llamasRP,document.getElementById("camelsIn").value=camelsRP);break;case"cats":catsRP=document.getElementById("catsIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(catsRP=20-camelsRP-chickensRP-cowsRP-dogsRP-fishRP-horsesRP-llamasRP,document.getElementById("catsIn").value=catsRP);break;case"chickens":chickensRP=document.getElementById("chickensIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(chickensRP=20-catsRP-camelsRP-cowsRP-dogsRP-fishRP-horsesRP-llamasRP,document.getElementById("chickensIn").value=chickensRP);break;case"cows":cowsRP=document.getElementById("cowsIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(cowsRP=20-catsRP-chickensRP-camelsRP-dogsRP-fishRP-horsesRP-llamasRP,document.getElementById("cowsIn").value=cowsRP);break;case"dogs":dogsRP=document.getElementById("dogsIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(dogsRP=20-catsRP-chickensRP-cowsRP-camelsRP-fishRP-horsesRP-llamasRP,document.getElementById("dogsIn").value=dogsRP);break;case"fish":fishRP=document.getElementById("fishIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(fishRP=20-catsRP-chickensRP-cowsRP-dogsRP-camelsRP-horsesRP-llamasRP,document.getElementById("fishIn").value=fishRP);break;case"horses":horsesRP=document.getElementById("horsesIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(horsesRP=20-catsRP-chickensRP-cowsRP-dogsRP-fishRP-camelsRP-llamasRP,document.getElementById("horsesIn").value=horsesRP);break;case"llamas":llamasRP=document.getElementById("llamasIn").value,+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP>20&&(llamasRP=20-catsRP-chickensRP-cowsRP-dogsRP-fishRP-horsesRP-camelsRP,document.getElementById("llamasIn").value=llamasRP)}remainingRP=Math.max(0,20-camelsRP-catsRP-chickensRP-cowsRP-dogsRP-fishRP-horsesRP-llamasRP),animalRP.innerHTML="Resource Points remaining: "+String(remainingRP)}function recalcPlantRP(e){switch(e){case"beans":beansRP=document.getElementById("beansIn").value,+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP>20&&(beansRP=20-cornRP-orangesRP-pinetreesRP-potatoesRP-rosesRP-wheatRP,document.getElementById("beansIn").value=beansRP);break;case"corn":cornRP=document.getElementById("cornIn").value,+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP>20&&(cornRP=20-beansRP-orangesRP-pinetreesRP-potatoesRP-rosesRP-wheatRP,document.getElementById("cornIn").value=cornRP);break;case"oranges":orangesRP=document.getElementById("orangesIn").value,+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP>20&&(orangesRP=20-cornRP-beansRP-pinetreesRP-potatoesRP-rosesRP-wheatRP,document.getElementById("orangesIn").value=orangesRP);break;case"pinetrees":pinetreesRP=document.getElementById("pinetreesIn").value,+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP>20&&(pinetreesRP=20-cornRP-orangesRP-beansRP-potatoesRP-rosesRP-wheatRP,document.getElementById("pinetreesIn").value=pinetreesRP);break;case"potatoes":potatoesRP=document.getElementById("potatoesIn").value,+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP>20&&(potatoesRP=20-cornRP-orangesRP-pinetreesRP-beanssRP-rosesRP-wheatRP,document.getElementById("potatoesIn").value=potatoesRP);break;case"roses":rosesRP=document.getElementById("rosesIn").value,+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP>20&&(rosesRP=20-cornRP-orangesRP-pinetreesRP-potatoesRP-beansRP-wheatRP,document.getElementById("rosesIn").value=rosesRP);break;case"wheat":wheatRP=document.getElementById("wheatIn").value,+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP>20&&(wheatRP=20-cornRP-orangesRP-pinetreesRP-potatoesRP-rosesRP-beansRP,document.getElementById("wheatIn").value=wheatRP)}remainingRP=Math.max(0,20-beansRP-cornRP-orangesRP-pinetreesRP-potatoesRP-rosesRP-wheatRP),plantRP.innerHTML="Resource Points remaining: "+String(remainingRP)}function recalcMaterialRP(e){switch(e){case"bronze":bronzeRP=document.getElementById("bronzeIn").value,+bronzeRP+ +goldRP+ +ironRP+ +silkRP+ +stoneRP>10&&(bronzeRP=10-goldRP-ironRP-silkRP-stoneRP,document.getElementById("bronzeIn").value=bronzeRP);break;case"gold":goldRP=document.getElementById("goldIn").value,+bronzeRP+ +goldRP+ +ironRP+ +silkRP+ +stoneRP>10&&(goldRP=10-bronzeRP-ironRP-silkRP-stoneRP,document.getElementById("goldIn").value=goldRP);break;case"iron":ironRP=document.getElementById("ironIn").value,+bronzeRP+ +goldRP+ +ironRP+ +silkRP+ +stoneRP>10&&(bronzeRP=10-goldRP-bronzeRP-silkRP-stoneRP,document.getElementById("ironIn").value=ironRP);break;case"silk":silkRP=document.getElementById("silkIn").value,+bronzeRP+ +goldRP+ +ironRP+ +silkRP+ +stoneRP>10&&(silkRP=10-goldRP-ironRP-bronzeRP-stoneRP,document.getElementById("silkIn").value=silkRP);break;case"stone":stoneRP=document.getElementById("stoneIn").value,+bronzeRP+ +goldRP+ +ironRP+ +silkRP+ +stoneRP>10&&(stoneRP=10-goldRP-ironRP-bronzeRP-silkRP,document.getElementById("stoneIn").value=stoneRP)}remainingRP=Math.max(0,10-bronzeRP-goldRP-ironRP-silkRP-stoneRP),materialRP.innerHTML="Resource Points remaining: "+String(remainingRP)}function hideLeftGameDivs(){$("#resourceBonuses").hide(),$("#trade").hide(),$("#reviewTrades").hide(),$("#plague").hide(),$("#events").hide(),$("#yearEnd").hide(),$("#war").hide()}function populateRightUI(){for(var e in ruiCivName.innerHTML=player.civname+" "+drawLocation(player.civlocation),ruiYear.innerHTML="Year: "+player.year,ruiPop.innerHTML="Population: "+player.score,ruiAnimals.innerHTML="",ruiPlants.innerHTML="",ruiMaterials.innerHTML="",player.animals)0!=player.animals[e]&&(ruiAnimals.innerHTML+=capitalizeFirstLetter(e)+": "+drawResource(e,player.animals[e])+"<br>");for(var a in player.plants)0!=player.plants[a]&&(ruiPlants.innerHTML+=capitalizeFirstLetter(a)+": "+drawResource(a,player.plants[a])+"<br>");for(var s in player.materials)0!=player.materials[s]&&(ruiMaterials.innerHTML+=capitalizeFirstLetter(s)+": "+drawResource(s,player.materials[s])+"<br>")}function drawResizedNav(){null!=currentStage&&drawYearNav(currentStage)}function drawYearNav(e){switch(ctx.clearRect(0,0,c.width,c.height),c.width=Math.ceil(.8*window.innerWidth),ctx.textAlign="center",ctx.beginPath(),ctx.moveTo(c.width/5,25),ctx.lineTo(4*c.width/5,25),ctx.stroke(),ctx.arc(c.width/5,25,3,0,2*Math.PI),ctx.arc(2*c.width/5,25,3,0,2*Math.PI),ctx.arc(3*c.width/5,25,3,0,2*Math.PI),ctx.arc(4*c.width/5,25,3,0,2*Math.PI),ctx.fill(),e){case"resource bonuses":ctx.beginPath(),ctx.arc(c.width/5,25,5,0,2*Math.PI),ctx.fillStyle="blue",ctx.fill(),ctx.font="bold 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Resource bonuses",c.width/5,10),ctx.fillStyle="black",ctx.font="normal 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Events",2*c.width/5,10),ctx.fillText("Trades",3*c.width/5,10),ctx.fillText("End of year",4*c.width/5,10);break;case"events":ctx.beginPath(),ctx.arc(2*c.width/5,25,5,0,2*Math.PI),ctx.fillStyle="blue",ctx.fill(),ctx.font="bold 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Events",2*c.width/5,10),ctx.fillStyle="black",ctx.font="normal 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Resource bonuses",c.width/5,10),ctx.fillText("Trades",3*c.width/5,10),ctx.fillText("End of year",4*c.width/5,10);break;case"trades":case"trades2":ctx.beginPath(),ctx.arc(3*c.width/5,25,5,0,2*Math.PI),ctx.fillStyle="blue",ctx.fill(),ctx.font="bold 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Trades",3*c.width/5,10),ctx.fillStyle="black",ctx.font="normal 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Resource bonuses",c.width/5,10),ctx.fillText("Events",2*c.width/5,10),ctx.fillText("End of year",4*c.width/5,10);break;case"end of year":ctx.beginPath(),ctx.arc(4*c.width/5,25,5,0,2*Math.PI),ctx.fillStyle="blue",ctx.fill(),ctx.font="bold 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("End of year",4*c.width/5,10),ctx.fillStyle="black",ctx.font="normal 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Resource bonuses",c.width/5,10),ctx.fillText("Events",2*c.width/5,10),ctx.fillText("Trades",3*c.width/5,10);break;default:ctx.font="normal 14px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",ctx.fillText("Resource bonuses",c.width/5,10),ctx.fillText("Events",2*c.width/5,10),ctx.fillText("Trades",3*c.width/5,10),ctx.fillText("End of year",4*c.width/5,10)}}function goToNextStage(){switch(drawYearNav(currentStage=nextStage),nextStage){case"resource bonuses":doResourceBonuses(),nextStage="events";break;case"events":doEvents(),nextStage="trades";break;case"trades":"none"==player.classcode?(drawYearNav("end of year"),doYearEnd(),nextStage="resource bonuses"):(selectClassmateToTrade(),nextStage="trades2");break;case"trades2":var e=0;"none"==player.classcode?(drawYearNav("end of year"),doYearEnd(),nextStage="resource bonuses"):void 0!==player.trades&&(e=Object.keys(player.trades).length),0==e?(drawYearNav("end of year"),doYearEnd(),nextStage="resource bonuses"):(loadTrades(),nextStage="end of year");break;case"end of year":doYearEnd(),nextStage="resource bonuses"}}function doResourceBonuses(){yearStartPopulation=player.score,hideLeftGameDivs(),$("#resourceBonuses").show();var e=0;foodBonusCalcHtml="",foodBonusReferenceHtml="<table border='1'><tr><th>Resource</th><th>Bonus</th></tr>",$.each(foodBonusDict,function(e,a){foodBonusReferenceHtml+="<tr><td>"+capitalizeFirstLetter(e)+" "+drawResource(e)+"</td><td>"+a+"%</td></tr>"}),foodBonusReference.innerHTML=foodBonusReferenceHtml+"</table>",$.each(player.resources,function(a,s){a in foodBonusDict&&0!=s&&(foodBonusCalcHtml+="With your "+String(s)+" "+a+" "+drawResource(a)+", your population grows by "+foodBonusDict[a]*s+"%. <br>",e+=foodBonusDict[a]*s)}),newScore=Math.ceil(player.score*(1+e/100)),foodBonusCalc.innerHTML=foodBonusCalcHtml+"<br>Your total population growth from food bonuses this year is "+String(e)+"%. Your new population is "+String(newScore)+".",db.ref("users/"+user.uid).update({score:newScore}),userdb.update({nextstage:"events"})}function selectClassmateToTrade(){$("#tradeOffer").hide(),classmateToTrade.innerHTML="Loading classmates...",tradeClassmatesInstructions.innerHTML="Select a classmate to trade with. You can only have one active trade proposal per classmate.",hideLeftGameDivs(),$("#trade").show(),loadClassmateUids()}function loadClassmateUids(){classmateUids=[],db.ref("classrooms/"+player.classcode+"/members/").once("value").then(function(e){for(var a in e.val())a!=user.uid&&classmateUids.push(a);classmateNum=0,classmateUids.length>0?($("#tradeClassmates").show(),$("#noClassmates").hide(),showClassmateResources(classmateUids[classmateNum])):(noClassmates.innerHTML="It looks like there aren't any classmates in your class - ask your friends to join you using your class code, "+player.classcode,$("#tradeClassmates").hide(),$("#noClassmates").show())})}function showClassmateResources(e){receiverUid=e,db.ref("users/"+e).once("value").then(function(e){for(var a in classmate=e.val(),classmate.plants["pine trees"]=classmate.plants.pinetrees,delete classmate.plants.pinetrees,classmate.resources=$.extend({},classmate.animals,classmate.plants,classmate.materials),classmateToTradeHtml="<b>"+classmate.civname+"</b>, founded by "+classmate.name+"<br><table border='1' style='margin-left:auto; margin-right:auto;'><tr><th>Animals</th><th>Plants</th><th>Materials</th></tr><tr><td valign='top'>",classmate.animals)0!=classmate.animals[a]&&(classmateToTradeHtml+=a+": "+classmate.animals[a]+" "+drawResource(a)+"<br>");for(var s in classmateToTradeHtml+="</td><td valign='top'>",classmate.plants)0!=classmate.plants[s]&&(classmateToTradeHtml+=s+": "+classmate.plants[s]+" "+drawResource(s)+"<br>");for(var t in classmateToTradeHtml+="</td><td valign='top'>",classmate.materials)0!=classmate.materials[t]&&(classmateToTradeHtml+=t+": "+classmate.materials[t]+" "+drawResource(t)+"<br>");classmateToTrade.innerHTML=classmateToTradeHtml+"</td></tr></table>",tradeWithBtn.innerHTML="Trade with "+classmate.firstname})}function loadTrades(){hideLeftGameDivs(),$("#reviewTrades").show(),tradesIn.innerHTML="<h3>Trade proposals sent to you</h3>",tradesOut.innerHTML="<h3>Trade proposals you've sent</h3>",$.each(player.trades,function(e,a){db.ref("trades/"+e).once("value").then(function(a){var s=a.val();s.creatorUid!=user.uid&&"pending"==s.status&&db.ref("users/"+s.creatorUid+"/firstname").once("value").then(function(a){var t=a.val();tradesIn.innerHTML+=t+" wants to trade ",$.each(s.creatorOffer,function(e,a){tradesIn.innerHTML+=drawResource(e,a)}),tradesIn.innerHTML+=" for your ",$.each(s.receiverOffer,function(e,a){tradesIn.innerHTML+=drawResource(e,a)}),tradesIn.innerHTML+=". You decide: <img src='images/accept.gif' height='16' title='accept' id='A"+e+"'>  <img src='images/reject.gif' height='16' title='reject' id='R"+e+"'><br><br>",$(document).on("click","#A"+e,function(e){processTrade($(this).attr("id").slice(1),"accept")}),$(document).on("click","#R"+e,function(e){processTrade($(this).attr("id").slice(1),"reject")})}),s.creatorUid==user.uid&&"accepted"==s.status&&db.ref("users/"+s.receiverUid+"/firstname").once("value").then(function(a){var t=a.val();tradesOut.innerHTML+=t+" accepted your trade proposal. You received ",$.each(s.receiverOffer,function(e,a){tradesOut.innerHTML+=drawResource(e,a)}),tradesOut.innerHTML+=" for your ",$.each(s.creatorOffer,function(e,a){tradesOut.innerHTML+=drawResource(e,a)}),tradesOut.innerHTML+=". <br>";var r={};r["users/"+user.uid+"/trades/"+e]=null,r["users/"+s.receiverUid+"/trades/"+e]=null,r["trades/"+e]=null,$.each(s.creatorOffer,function(e,a){switch(e){case"camels":case"cats":case"chickens":case"cows":case"dogs":case"fish":case"horses":case"llamas":r["users/"+user.uid+"/animals/"+e]=player.animals[e]-a;break;case"beans":case"corn":case"oranges":case"potatoes":case"roses":case"wheat":r["users/"+user.uid+"/plants/"+e]=player.plants[e]-a;break;case"pine trees":r["users/"+user.uid+"/plants/pinetrees/"]=player.plants[e]-a;break;case"bronze":case"gold":case"iron":case"silk":case"stone":r["users/"+user.uid+"/materials/"+e]=player.materials[e]-a}}),$.each(s.receiverOffer,function(e,a){switch(e){case"camels":case"cats":case"chickens":case"cows":case"dogs":case"fish":case"horses":case"llamas":r["users/"+user.uid+"/animals/"+e]=player.animals[e]+a;break;case"beans":case"corn":case"oranges":case"potatoes":case"roses":case"wheat":r["users/"+user.uid+"/plants/"+e]=player.plants[e]+a;break;case"pine trees":r["users/"+user.uid+"/plants/pinetrees/"]=player.plants[e]+a;break;case"bronze":case"gold":case"iron":case"silk":case"stone":r["users/"+user.uid+"/materials/"+e]=player.materials[e]+a}}),db.ref().update(r)}),s.creatorUid==user.uid&&"rejected"==s.status&&db.ref("users/"+s.receiverUid+"/firstname").once("value").then(function(a){var t=a.val();tradesOut.innerHTML+=t+" rejected your trade proposal. You asked for ",$.each(s.receiverOffer,function(e,a){tradesOut.innerHTML+=drawResource(e,a)}),tradesOut.innerHTML+=" for your ",$.each(s.creatorOffer,function(e,a){tradesOut.innerHTML+=drawResource(e,a)}),tradesOut.innerHTML+=". <br>";var r={};r["users/"+user.uid+"/trades/"+e]=null,r["users/"+s.receiverUid+"/trades/"+e]=null,r["trades/"+e]=null,db.ref().update(r)}),s.creatorUid==user.uid&&"pending"==s.status&&db.ref("users/"+s.receiverUid+"/firstname").once("value").then(function(e){var a=e.val();tradesOut.innerHTML+=a+" is still considering your trade proposal. You asked for ",$.each(s.receiverOffer,function(e,a){tradesOut.innerHTML+=drawResource(e,a)}),tradesOut.innerHTML+=" for your ",$.each(s.creatorOffer,function(e,a){tradesOut.innerHTML+=drawResource(e,a)}),tradesOut.innerHTML+=". <br>"})})})}function processTrade(e,a){db.ref("trades/"+e).once("value").then(function(s){var t=s.val(),r={};db.ref("users/"+t.creatorUid).once("value").then(function(s){classmate=s.val(),classmate.plants["pine trees"]=classmate.plants.pinetrees,delete classmate.plants.pinetrees,classmate.resources=$.extend({},classmate.animals,classmate.plants,classmate.materials),$.each(t.creatorOffer,function(e,s){s>classmate.resources[e]&&(alert("This trade is no longer valid - "+classmate.firstname+" no longer has the resources required to complete it. It has been automatically rejected."),a="reject")}),$.each(t.receiverOffer,function(e,s){s>player.resources[e]&&(alert("This trade is no longer valid - you no longer have the resources required to complete it. It has been automatically rejected."),a="reject")}),"accept"==a?(r["users/"+user.uid+"/trades/"+e]="accepted",r["users/"+t.creatorUid+"/trades/"+e]="accepted",r["trades/"+e+"/status"]="accepted",$.each(t.receiverOffer,function(e,a){switch(e){case"camels":case"cats":case"chickens":case"cows":case"dogs":case"fish":case"horses":case"llamas":r["users/"+user.uid+"/animals/"+e]=player.animals[e]-a;break;case"beans":case"corn":case"oranges":case"potatoes":case"roses":case"wheat":r["users/"+user.uid+"/plants/"+e]=player.plants[e]-a;break;case"pine trees":r["users/"+user.uid+"/plants/pinetrees/"]=player.plants[e]-a;break;case"bronze":case"gold":case"iron":case"silk":case"stone":r["users/"+user.uid+"/materials/"+e]=player.materials[e]-a}}),$.each(t.creatorOffer,function(e,a){switch(e){case"camels":case"cats":case"chickens":case"cows":case"dogs":case"fish":case"horses":case"llamas":r["users/"+user.uid+"/animals/"+e]=player.animals[e]+a;break;case"beans":case"corn":case"oranges":case"potatoes":case"roses":case"wheat":r["users/"+user.uid+"/plants/"+e]=player.plants[e]+a;break;case"pine trees":r["users/"+user.uid+"/plants/pinetrees/"]=player.plants[e]+a;break;case"bronze":case"gold":case"iron":case"silk":case"stone":r["users/"+user.uid+"/materials/"+e]=player.materials[e]+a}}),readyToLoad=!0,db.ref().update(r).then(function(){readyToLoad&&loadTrades(),readyToLoad=!1})):(r["users/"+user.uid+"/trades/"+e]="rejected",r["users/"+t.creatorUid+"/trades/"+e]="rejected",r["trades/"+e+"/status"]="rejected",readyToLoad=!0,db.ref().update(r).then(function(){readyToLoad&&loadTrades(),readyToLoad=!1}))})})}function doEvents(){4==player.year?(hideLeftGameDivs(),$("#plague").show(),plagueText.innerHTML="In Year 4, the Bubonic Plague hits the world.<br><br> Civilizations with cats, chickens, cows, dogs or horses are devastated.<br><br>",player.animals.cats>0||player.animals.chickens>0||player.animals.cows>0||player.animals.dogs>0||player.animals.horses>0?(plagueText.innerHTML+="Your civilization is struck hard. In your second year of existence, <b>fifty percent</b> of your civilization is wiped out before the spread of the disease is stopped.<br><br>You can only hope you never encounter a disease like this again...",db.ref("users/"+user.uid).update({plague:1,score:Math.ceil(player.score/2)})):plagueText.innerHTML+="Lacking these animals, your civilization is miraculously spared from the plague.<br><br>You can only hope it doesn't come back some day..."):10==player.year?(hideLeftGameDivs(),$("#plague").show(),plagueText.innerHTML="In Year 10, the Bubonic Plague hits the world again.<br><br>This time, it's much worse. It spreads from person to person - it no longer matters what animals your civilization has.<br><br>",1==player.plague?plagueText.innerHTML+="Fortunately, your civilization is IMMUNE. Having suffered the effects of the plague six years ago, your population has built up an immunity towards it. All of your civilians are safe.":(plagueText.innerHTML+="Your civilization is struck hard. Since you weren't affected by the outbreak six years ago, your population has no immunity towards the plague. As a result, <b>ninety percent</b> of your civilization is wiped out.<br><br>You can only hope you never encounter a disease like this again...",db.ref("users/"+user.uid).update({plague:1,score:Math.ceil(.1*player.score)}))):player.year%3==0?doWar():(document.getElementById("nextStageBtn").disabled=!0,hideLeftGameDivs(),$("#events").show(),eventsObjArray=shuffle(eventsObjArray),monthsClicked=0,eventlist.innerHTML="<br><br>",eventCalYear.innerHTML="<h2>Year "+String(player.year)+"</h2>",$("#eventCal1,#eventCal2,#eventCal3,#eventCal4,#eventCal5,#eventCal6,#eventCal7,#eventCal8,#eventCal9,#eventCal10,#eventCal11,#eventCal12").each(function(){this.className="eventMonth"}),$(".eventMonth").click(function(){if(monthsClicked<3&&"eventMonth"==this.className){monthsClicked++,this.className="eventMonthClicked";var e=eventsObjArray[Number(this.id.slice(8))],a=[],s=[],t=!1,r=Object.keys(e);try{$.each(Object.values(e),function(e,s){"TRUE"==s&&a.push(e)})}catch(e){eventlist.innerHTML="Unfortunately, your internet browser is out of date and is causing an issue with generating events. Please update your browser and refresh the page to continue your civilization's journey!"}if($.each(Object.values(e),function(e,a){"FALSE"==a&&s.push(e)}),$.each(a,function(a,s){(player.resources[r[s]]>0||"TRUE"==e.all||r[s]==player.civlocation)&&(t=!0)}),$.each(s,function(e,a){0!=player.resources[r[a]]&&null!=player.resources[r[a]]||(t=!0)}),t)if(isNaN(Number(e.pts))){var n={};if("-"==e.pts.slice(0,1)){var o=e.pts.slice(1);switch(eventlistHtml="<span style='color:red'>",o){case"camels":case"cats":case"chickens":case"cows":case"dogs":case"fish":case"horses":case"llamas":n["users/"+user.uid+"/animals/"+o]=player.animals[o]-1;break;case"beans":case"corn":case"oranges":case"potatoes":case"roses":case"wheat":n["users/"+user.uid+"/plants/"+o]=player.plants[o]-1;break;case"pine trees":n["users/"+user.uid+"/plants/pinetrees/"]=player.plants[o]-1;break;case"bronze":case"gold":case"iron":case"silk":case"stone":n["users/"+user.uid+"/materials/"+o]=player.materials[o]-1}}else{switch(eventlistHtml="<span style='color:green'>",o=e.pts){case"camels":case"cats":case"chickens":case"cows":case"dogs":case"fish":case"horses":case"llamas":n["users/"+user.uid+"/animals/"+o]=player.animals[o]+1;break;case"beans":case"corn":case"oranges":case"potatoes":case"roses":case"wheat":n["users/"+user.uid+"/plants/"+o]=player.plants[o]+1;break;case"pine trees":n["users/"+user.uid+"/plants/pinetrees/"]=player.plants[o]+1;break;case"bronze":case"gold":case"iron":case"silk":case"stone":n["users/"+user.uid+"/materials/"+o]=player.materials[o]+1}}db.ref().update(n),eventlist.innerHTML+=eventlistHtml+capitalizeFirstLetter(e.name)+": "+e.posdesc+"</span> "+drawResource(o)+"<br><br>"}else Number(e.pts)<0?eventlistHtml="<span style='color:red'>":eventlistHtml="<span style='color:green'>",eventlist.innerHTML+=eventlistHtml+capitalizeFirstLetter(e.name)+": "+e.posdesc+"</span><br><br>",db.ref("users/"+user.uid).update({score:Math.round(player.score*(100+Number(e.pts))/100)});else isNaN(Number(e.pts))?eventlistHtml="<span style='color:green'>":Number(e.pts)>0?eventlistHtml="<span style='color:red'>":eventlistHtml="<span style='color:green'>",eventlist.innerHTML+=eventlistHtml+capitalizeFirstLetter(e.name)+": "+e.negdesc+"</span><br><br>";monthsClicked>=3&&(document.getElementById("nextStageBtn").disabled=!1,$(".eventMonth").each(function(){this.className="eventMonthDisabled"}),eventlist.innerHTML+="That's all the events for this year!","none"==player.classcode?userdb.update({nextstage:"year end"}):userdb.update({nextstage:"trades"}))}}))}function phaserPreload(){game.load.image("flagSymbol","images/locations/"+player.civlocation+".gif"),game.load.atlasJSONArray("warImages","images/war/warImages.png","images/war/warImages.json"),game.load.atlasJSONArray("fire","images/war/fireAnimation.png","images/war/fireAnimation.json")}function phaserCreate(){for(game.stage.backgroundColor="#7ce87e",game.physics.startSystem(Phaser.Physics.ARCADE),leftEmitter=game.add.emitter(-2,200,1e3),leftEmitter.height=100,leftEmitter.setXSpeed(100,200),leftEmitter.setYSpeed(-10,10),leftEmitter.minRotation=0,leftEmitter.maxRotation=0,leftEmitter.gravity=0,leftEmitter.makeParticles("warImages","warrior.png",void 0,!0,!1),leftEmitter.start(!1,1e4,millisecondsPerWarrior),huts=game.add.group(),hutsRemaining=5,huts.enableBody=!0,i=18;i<500;i+=100){var e=huts.create(5,i,"warImages","hut1.png");e.body.immovable=!0,e.health=100}rightEmitter=game.add.emitter(802,250,1e3),rightEmitter.height=game.world.height,rightEmitter.setXSpeed(-100,-200),rightEmitter.setYSpeed(-50,50),rightEmitter.minRotation=0,rightEmitter.maxRotation=0,rightEmitter.gravity=0,rightEmitter.makeParticles("warImages","enemy.png",void 0,!0,!1),rightEmitter.start(!1,3e4,millisecondsPerEnemy),flag=game.add.sprite(7,220,"warImages","flag.png"),flagSymbol=game.add.sprite(13,225,"flagSymbol",0),flagSymbol.scale.setTo(.05,.05),fireArray=[],gameTimer=game.time.create(!1),gameTimer.add(3e4,gameEnd,this),gameTimer.start(),timerTextStyle={font:"bold 20px 'Palatino Linotype', 'Book Antiqua', Palatino, serif"},timerText=game.add.text(530,450,"Time remaining: 30 seconds",timerTextStyle)}function phaserUpdate(){timerText.text="Time remaining: "+(gameTimer.duration/1e3).toFixed(0)+" seconds",game.physics.arcade.overlap(leftEmitter,rightEmitter,function(e,a){Math.random()<warriorKillChance?(a.kill(),e.body.velocity.x=100+100*Math.random(),e.body.velocity.y=100*Math.random()-50):(e.kill(),a.body.velocity.x=-100-100*Math.random(),a.body.velocity.y=100*Math.random()-50)}),game.physics.arcade.collide(rightEmitter,huts,function(e,a){e.body.velocity.x=0,e.body.velocity.y=0,a.health=a.health-1,game.time.events.add(200,function(){e.body.velocity.x=-100-100*Math.random(),e.body.velocity.y=100*Math.random()-50},this),70==a.health&&a.loadTexture("warImages","hut2.png");40==a.health&&function(e){var a=game.add.sprite(e.x-18,e.y-18,"fire");a.scale.setTo(.5,.5),a.alpha=.9,a.animations.add("fireAnimation"),a.animations.play("fireAnimation",30,!0),fireArray.push(a)}(a);if(a.health<0){for(i=0;i<fireArray.length;i++)fireArray[i].y==a.y-18&&fireArray[i].destroy();a.body=null,a.loadTexture("warImages","hut3.png"),a.alpha=.5,hutsRemaining--,0==hutsRemaining&&gameEnd()}}),game.input.keyboard.isDown(Phaser.Keyboard.UP)&&leftEmitter.y>32?leftEmitter.y-=5:game.input.keyboard.isDown(Phaser.Keyboard.DOWN)&&leftEmitter.y<game.world.height&&(leftEmitter.y+=5),flag.y=leftEmitter.y-30,flagSymbol.y=leftEmitter.y-25}function doWar(){document.getElementById("nextStageBtn").disabled=!0,hideLeftGameDivs(),$("#war").show(),$("#warText").hide(),$("#warTable").show(),warriorKillChanceCalc(),flowCalc(),warInstructions.innerHTML="It's time for war.<br><br>Based on your resources and your location, your soldiers will have a "+String(Math.round(100*warriorKillChance))+"% chance of defeating enemies they encounter on the battlefield.<br><br>Use the Up and Down arrow keys on your keyboard to direct your soldiers into battle. The larger your population, the more soldiers you'll have in battle. Your goal is to defend your huts for thirty seconds - otherwise the enemy will kill some of your civilians!<br><br>";var e=document.createElement("BUTTON"),a=document.createTextNode("I'm ready");e.appendChild(a),e.onclick=function(){$("#warGame").show(),$("#warTable").hide(),game=new Phaser.Game(800,500,Phaser.AUTO,"warGame",{preload:phaserPreload,create:phaserCreate,update:phaserUpdate})},warInstructions.appendChild(e)}function warriorKillChanceCalc(){var e=0,a=0;$.each(warBonusResourceDict,function(e,a){}),$.each(player.resources,function(a,s){a in warBonusResourceDict&&0!=s&&(e+=warBonusResourceDict[a]*s)}),player.civLocation in warBonusLocationDict&&(a=warBonusLocationDict[player.civLocation]),warriorKillChance=Math.min(e+a,1),warBonusReferenceHtml="",warBonusReferenceHtml="<table border='1' style='float: right'><tr><th>Resource</th><th>Bonus</th></tr>",$.each(warBonusResourceDict,function(e,a){warBonusReferenceHtml+="<tr><td>"+capitalizeFirstLetter(e)+" "+drawResource(e)+"</td><td>"+100*a+"%</td></tr>"}),warBonusReferenceHtml+="</table><table border='1' style='float: right; margin-right: 10px'><tr><th>Location</th><th>Bonus</th></tr>",$.each(warBonusLocationDict,function(e,a){warBonusReferenceHtml+="<tr><td>"+capitalizeFirstLetter(e)+" "+drawLocation(e,16)+"</td><td>"+100*a+"%</td></tr>"}),warBonusReference.innerHTML=warBonusReferenceHtml+"</table>"}function flowCalc(){totalWarriors=Math.ceil(player.score),millisecondsPerWarrior=Math.max(10,Math.ceil(3e4/totalWarriors)),millisecondsPerEnemy=Math.min(200,millisecondsPerWarrior)}function gameEnd(){game.paused=!0,timerText.destroy();var e=game.add.text(298,200,"Game over!",{font:"bold 40px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",fill:"#fff"}),a=game.add.text(283,250,"Click to continue",{font:"32px 'Palatino Linotype', 'Book Antiqua', Palatino, serif",fill:"#fff"});e.setShadow(3,3,"rgba(0,0,0,0.5)",2),a.setShadow(2,2,"rgba(0,0,0,0.5)",2),game.input.onDown.add(gameEnd2,self)}function gameEnd2(){"none"==player.classcode?userdb.update({nextstage:"end of year"}):userdb.update({nextstage:"trades"}),document.getElementById("nextStageBtn").disabled=!1;var e=gameTimer.duration;game.destroy(),$("#warGame").hide(),$("#warText").show(),hutsLost=5-hutsRemaining,0==e?5==hutsRemaining?warText.innerHTML="All of your huts survived! As a reward, you've seized a "+giveWarReward()+" from the enemy.":(warText.innerHTML="After thirty seconds, you've lost "+String(hutsLost)+" huts, costing you "+String(5*hutsLost)+"% of your population.<br><br>Grow your population to recruit a large army, and make sure you have resources that will help you in battle!",db.ref("users/"+user.uid).update({score:Math.ceil(player.score*(100-5*hutsLost)/100)})):0==hutsRemaining&&(warText.innerHTML="All of your huts were destroyed within "+String(30-(e/1e3).toFixed(0))+" seconds, costing you 25% of your population.<br><br>Grow your population to recruit a large army, and make sure you have resources that will help you in battle!",db.ref("users/"+user.uid).update({score:Math.ceil(.75*player.score)}))}function giveWarReward(){switch(rewardArray=["horse","camel","piece of gold","piece of iron"],reward=rewardArray[Math.floor(Math.random()*rewardArray.length)],reward){case"horse":db.ref("users/"+user.uid+"/animals/").update({horses:player.animals.horses+1}),rewardImg=drawResource("horses");break;case"camel":db.ref("users/"+user.uid+"/animals/").update({camels:player.animals.camels+1}),rewardImg=drawResource("camels");break;case"piece of gold":db.ref("users/"+user.uid+"/materials/").update({gold:player.materials.gold+1}),rewardImg=drawResource("gold");break;case"piece of iron":db.ref("users/"+user.uid+"/materials/").update({iron:player.materials.iron+1}),rewardImg=drawResource("iron")}return reward+" "+rewardImg}function doYearEnd(){yearEndPopulation=player.score,hideLeftGameDivs(),$("#yearEnd").show(),player.score>=1e5&&2!=player.plague?(db.ref("users/"+user.uid).update({plague:2}),yearEndText.innerHTML="<table><tr><td><img src='images/celebration.gif' height='300'></td><td>Congratulations - your civilization has grown to over 100,000 civilians in just "+player.year+" years. That's very impressive! You can start a new civilization by deleting this one below, or you can keep playing with this one and see how large you can grow!</td></tr></table>"):(factNum=(player.year-1)%factsArray.length,player.score<=0?(yearEndText.innerHTML="You have no civilians left - your civilization has been destroyed! Fortunately, a wandering party of five explorers wanders into the ruins of your civilization, allowing you to continue the game!<br><br>",db.ref("users/"+user.uid).update({score:5})):(yearEndText.innerHTML="Your civilization has survived through Year "+player.year+"! <br><br>","undefined"!=typeof yearStartPopulation&&(yearEndText.innerHTML+="You started Year "+player.year+" with a population of "+yearStartPopulation+" civilians, and you ended with "+yearEndPopulation+" civilians.<br><br>")),yearEndText.innerHTML+="Here's this year's fun fact:<br>"+factsArray[factNum]),db.ref("users/"+user.uid).update({year:player.year+1}),userdb.update({nextstage:"resource bonuses"})}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function drawResource(e,a,s,t){return("<img src='images/resources/"+e+".gif' height='"+(s=s||16)+"' title='"+e+"' class='"+(t=t||"")+"'> ").repeat(a=a||1)}function drawLocation(e,a){return"<img src='images/locations/"+e+".gif' height='"+(a=a||32)+"'>"}function checkAllZeroes(e){return e.every(function(e){return 0==e})}function shuffle(e){for(var a,s,t=e.length;0!==t;)s=Math.floor(Math.random()*t),a=e[t-=1],e[t]=e[s],e[s]=a;return e}function deleteCivConfirm(){confirm("Please confirm that you would like to completely delete your civilization. This will cancel all pending trades and erase your score. You cannot undo this action.")&&deleteMyCiv()}function deleteMyCiv(){var e={};if("undefined"!=typeof player)if(void 0===player.trades)s();else{var a=Object.keys(player.trades).length;$.each(player.trades,function(t,r){db.ref("trades/"+t).once("value").then(function(r){var n=r.val();e["users/"+n.receiverUid+"/trades/"+t]=null,e["users/"+n.creatorUid+"/trades/"+t]=null,e["trades/"+t]=null,0==--a&&s()})})}else s();function s(){"undefined"!=typeof player&&"none"!=player.classcode&&(e["classrooms/"+player.classcode+"/members/"+user.uid]=null),db.ref().update(e),userdb=db.ref("users/"+user.uid),userdb.remove(),location.reload()}}document.getElementById("googleSignIn").onclick=function(){firebase.auth().signInWithPopup(provider).then(function(e){e.credential.accessToken;user=e.user,db.ref("users/"+user.uid).once("value").then(function(e){db.ref("users/"+user.uid).update({name:user.displayName,firstname:user.displayName.substr(0,user.displayName.indexOf(" ")),email:user.email,photo:user.photoURL}),userdb=db.ref("users/"+user.uid),civExistsTest=e.val(),null==civExistsTest?($("#signInDiv").hide(),$("#classCodeDiv").show()):void 0===civExistsTest.materials||void 0===civExistsTest.animals||void 0===civExistsTest.plants?(alert("It looks your civilization wasn't created successfully - we're going to delete that and refresh the page to start again."),deleteMyCiv(),$("#signInDiv").hide(),$("#classCodeDiv").show()):($("#signInDiv").hide(),userdb.on("value",function(e){player=e.val(),player.plants["pine trees"]=player.plants.pinetrees,delete player.plants.pinetrees,player.resources=$.extend({},player.animals,player.plants,player.materials),populateRightUI()}),userdb.once("value",function(e){player=e.val(),player.plants["pine trees"]=player.plants.pinetrees,delete player.plants.pinetrees,player.resources=$.extend({},player.animals,player.plants,player.materials),populateRightUI(),$("#gameUI").show(),void 0===player.nextstage?nextStage="resource bonuses":nextStage=player.nextstage,drawYearNav(nextStage),goToNextStage()}))})}).catch(function(e){var a=e.code,s=e.message;e.email,e.credential;console.log(a+s)})},document.getElementById("classCodeCreateNameBtn").onclick=function(){""==document.getElementById("classCodeCreateNameIn").value?alert("Make sure you enter your name for your classroom!"):(document.getElementById("classCodeCreateNameBtn").disabled=!0,classCodeCreate2Div.innerHTML="Your classroom code is <b>"+classCodeGen+"</b>. Make sure your students input this correctly when they first log in! Press the button below if you'd like to play along.",db.ref("classrooms/"+classCodeGen).update({name:document.getElementById("classCodeCreateNameIn").value}))},document.getElementById("startAfterClassCodeCreate").onclick=function(){$("#classCodeCreateDiv").hide(),$("#classCodeDiv").show()},document.getElementById("createAnotherClassCode").onclick=function(){document.getElementById("classCodeCreateNameBtn").disabled=!1,generateClassCode()},document.getElementById("classCodeInBtn").onclick=function(){$("#classCodeConfirmDiv").show(),classCode=document.getElementById("classCodeIn").value.toUpperCase(),""!=classCode&&db.ref("classrooms/"+classCode).once("value").then(function(e){null!=e.val()?(classroomName=e.val().name,classCodeConfirmDiv.innerHTML="You are joining <b>"+classroomName+"</b>. If that isn't correct, please double-check your classroom code above and try again.<br><br><button id='classCodeContinueBtn'>Let's play!</button><br><br>",document.getElementById("classCodeContinueBtn").onclick=function(){$("#classCodeDiv").hide(),$("#civCreation1").show();var e={};e["users/"+user.uid+"/classcode"]=classCode,e["users/"+user.uid+"/classname"]=classroomName,e["classrooms/"+classCode+"/members/"+user.uid]=!0,db.ref().update(e)}):classCodeConfirmDiv.innerHTML="We didn't find that classroom code. Please double-check above and try again.<br><br>"})},document.getElementById("civNameInBtn").onclick=function(){civName=document.getElementById("civNameIn").value,""==civName?alert("You forgot to enter a name for your civilization!"):(userdb.update({civname:capitalizeFirstLetter(civName)}),$("#civCreation1").hide(),$("#civCreation2").show())},document.getElementById("civLocationInBtn").onclick=function(){civLocation=document.querySelector('input[name="civLocationIn"]:checked').value,""==civLocation?alert("Your civilization needs to be located somewhere!"):(userdb.update({civlocation:civLocation,year:1,score:10,rp:0,plague:0,nextstage:"resource bonuses"}),$("#civCreation2").hide(),$("#civCreation3").show(),remainingRP=20,camelsRP=0,catsRP=0,chickensRP=0,cowsRP=0,dogsRP=0,fishRP=0,horsesRP=0,llamasRP=0)},document.getElementById("civAnimalsInBtn").onclick=function(){camelsRP%1!=0||catsRP%1!=0||chickensRP%1!=0||cowsRP%1!=0||dogsRP%1!=0||fishRP%1!=0||horsesRP%1!=0||llamasRP%1!=0?alert("Make sure you're using only whole numbers - no decimals!"):+camelsRP<0||+catsRP<0||+chickensRP<0||+cowsRP<0||+dogsRP<0||+fishRP<0||+horsesRP<0||+llamasRP<0?alert("You've found a way to set one of your animals to a negative value - correct this and try again!"):+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP==20?($("#civCreation3").hide(),$("#civCreation4").show(),remainingRP=20,beansRP=0,cornRP=0,orangesRP=0,pinetreesRP=0,potatoesRP=0,rosesRP=0,wheatRP=0,db.ref("users/"+user.uid+"/animals/").update({camels:parseInt(camelsRP),cats:parseInt(catsRP),chickens:parseInt(chickensRP),cows:parseInt(cowsRP),dogs:parseInt(dogsRP),fish:parseInt(fishRP),horses:parseInt(horsesRP),llamas:parseInt(llamasRP)})):+camelsRP+ +catsRP+ +chickensRP+ +cowsRP+ +dogsRP+ +fishRP+ +horsesRP+ +llamasRP<20?alert("Make sure you spend all 20 Resource Points!"):alert("You've found a way to spend more Resource Points than you have - check your numbers again!")},document.getElementById("civPlantsInBtn").onclick=function(){beansRP%1!=0||cornRP%1!=0||orangesRP%1!=0||pinetreesRP%1!=0||potatoesRP%1!=0||rosesRP%1!=0||wheatRP%1!=0?alert("Make sure you're using only whole numbers - no decimals!"):+beansRP<0||+cornRP<0||+orangesRP<0||+pinetreesRP<0||+potatoesRP<0||+rosesRP<0||+wheatRP<0?alert("You've found a way to set one of your plants to a negative value - correct this and try again!"):+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP==20?($("#civCreation4").hide(),$("#civCreation5").show(),remainingRP=20,goldRP=0,ironRP=0,stoneRP=0,silkRP=0,bronzeRP=0,db.ref("users/"+user.uid+"/plants/").update({beans:parseInt(beansRP),corn:parseInt(cornRP),oranges:parseInt(orangesRP),pinetrees:parseInt(pinetreesRP),potatoes:parseInt(potatoesRP),roses:parseInt(rosesRP),wheat:parseInt(wheatRP)})):+beansRP+ +cornRP+ +orangesRP+ +pinetreesRP+ +potatoesRP+ +rosesRP+ +wheatRP<20?alert("Make sure you spend all 20 Resource Points!"):alert("You've found a way to spend more Resource Points than you have - check your numbers again!")},document.getElementById("civMaterialsInBtn").onclick=function(){bronzeRP%1!=0||goldRP%1!=0||ironRP%1!=0||silkRP%1!=0||stoneRP%1!=0?alert("Make sure you're using only whole numbers - no decimals!"):+bronzeRP<0||+goldRP<0||+ironRP<0||+silkRP<0||+stoneRP<0?alert("You've found a way to set one of your materials to a negative value - correct this and try again!"):+bronzeRP+ +goldRP+ +ironRP+ +silkRP+ +stoneRP==10?($("#civCreation5").hide(),userdb.once("value",function(e){player=e.val(),player.plants["pine trees"]=player.plants.pinetrees,delete player.plants.pinetrees,player.resources=$.extend({},player.animals,player.plants,player.materials),populateRightUI(),$("#gameUI").show(),currentStage="resource bonuses",nextStage="events",drawYearNav("resource bonuses"),doResourceBonuses()}),db.ref("users/"+user.uid+"/materials/").update({bronze:parseInt(bronzeRP),gold:parseInt(goldRP),iron:parseInt(ironRP),silk:parseInt(silkRP),stone:parseInt(stoneRP)}),userdb.on("value",function(e){player=e.val(),player.plants["pine trees"]=player.plants.pinetrees,delete player.plants.pinetrees,player.resources=$.extend({},player.animals,player.plants,player.materials),populateRightUI()})):+bronzeRP+ +goldRP+ +ironRP+ +silkRP+ +stoneRP<10?alert("Make sure you spend all 10 Resource Points!"):alert("You've found a way to spend more Resource Points than you have - check your numbers again!")},document.getElementById("nextStageBtn").onclick=function(){goToNextStage()},$("#tradeRightArrow").click(function(){classmateNum+1==classmateUids.length?classmateNum=0:classmateNum++,showClassmateResources(classmateUids[classmateNum])}),$("#tradeLeftArrow").click(function(){0==classmateNum?classmateNum=classmateUids.length-1:classmateNum--,showClassmateResources(classmateUids[classmateNum])}),$("#tradeWithBtn").click(function(){for(var e in creatorOffer={},receiverOffer={},$("#tradeClassmates").hide(),$("#tradeOffer").show(),classmateCivHasHeader.innerHTML=classmate.civname+" has...",classmateCivGivesHeader.innerHTML=classmate.firstname+" will trade...",playerCivHasHeader.innerHTML=player.civname+" has...",playerCivGivesHeader.innerHTML="You offer...",classmateCivHas.innerHTML="",classmateCivGives.innerHTML="",playerCivHas.innerHTML="",playerCivGives.innerHTML="",classmate.resources)0!=classmate.resources[e]&&(classmateCivHas.innerHTML+=drawResource(e,classmate.resources[e],32,"classmateResourceToTrade")+" ");for(var e in player.resources)0!=player.resources[e]&&(playerCivHas.innerHTML+=drawResource(e,player.resources[e],32,"playerResourceToTrade")+" ");$(".classmateResourceToTrade").click(function(){"classmateResourceToTrade"==$(this).attr("class")?(receiverOffer[$(this).attr("title")]=receiverOffer[$(this)[0].getAttribute("title")]+1||1,$("#classmateCivGives").append($(this)[0]),$(this).attr("class","classmateResourceInTrade")):(receiverOffer[$(this).attr("title")]=receiverOffer[$(this)[0].getAttribute("title")]-1,$("#classmateCivHas").append($(this)[0]),$(this).attr("class","classmateResourceToTrade"))}),$(".playerResourceToTrade").click(function(){"playerResourceToTrade"==$(this).attr("class")?(creatorOffer[$(this).attr("title")]=creatorOffer[$(this)[0].getAttribute("title")]+1||1,$("#playerCivGives").append($(this)[0]),$(this).attr("class","playerResourceInTrade")):(creatorOffer[$(this).attr("title")]=creatorOffer[$(this)[0].getAttribute("title")]-1,$("#playerCivHas").append($(this)[0]),$(this).attr("class","playerResourceToTrade"))})}),$("#proposeTradeBtn").click(function(){jQuery.isEmptyObject(receiverOffer)||jQuery.isEmptyObject(creatorOffer)||checkAllZeroes(Object.values(receiverOffer))||checkAllZeroes(Object.values(creatorOffer))?alert("Make sure your trade includes at least one resource from both you and your classmate!"):(db.ref("trades/"+user.uid+receiverUid).set({status:"pending",creatorUid:user.uid,receiverUid:receiverUid,creationTime:(new Date).getTime(),receiverOffer:receiverOffer,creatorOffer:creatorOffer}),db.ref("users/"+user.uid+"/trades/").update({[user.uid+receiverUid]:"pending"}),db.ref("users/"+receiverUid+"/trades/").update({[user.uid+receiverUid]:"pending"}),$("#tradeOffer").hide(),$("#tradeClassmates").show(),tradeClassmatesInstructions.innerHTML="Your trade has been proposed! Select another classmate to trade with. You can only have one active trade proposal per classmate.")}),$("#cancelTradeBtn").click(function(){$("#tradeOffer").hide(),$("#tradeClassmates").show(),tradeClassmatesInstructions.innerHTML="Your trade has been cancelled. Select another classmate to trade with. You can only have one active trade proposal per classmate."});